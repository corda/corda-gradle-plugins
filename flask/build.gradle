plugins {
    id 'groovy'
    id "java-gradle-plugin"
}

evaluationDependsOn("common")
evaluationDependsOn("launcher")

dependencies {
    compileOnly project("common")
}

FileCollection launcherTar = project("launcher").tasks.named("tar").get().outputs.files
FileCollection commonJar = project("common").tasks.named("jar").get().outputs.files

Provider<Copy> copyLauncher = tasks.register("copyLauncher", Copy) {
    from(launcherTar)
    into(new File(project.buildDir, "resources/main/META-INF"))
    rename 'launcher-.*\\.tar', 'flask-launcher.tar'
}

tasks.named("processResources") {
    inputs.files(copyLauncher.get().outputs)
}

jar {
    manifest {
        attributes "version" : archiveVersion.get()
    }
    from(zipTree(commonJar.singleFile))
//    inputs.files(launcherTar)
//
//    from(launcherTar) {
//        into("META-INF")
//        rename 'launcher-.*\\.tar', 'flask-launcher.tar'
//    }
}

gradlePlugin {
    plugins {
        jarFilterPlugin {
            id = 'net.corda.plugins.flask'
            implementationClass = 'net.corda.gradle.flask.FlaskPlugin'
        }
    }
    automatedPublishing = false
}

repositories {
    mavenCentral()
}

dependencies {
    testImplementation "org.junit.jupiter:junit-jupiter-api:$junit_jupiter_version"
    testRuntimeOnly "org.junit.jupiter:junit-jupiter-engine:$junit_jupiter_version"
}

tasks.named("pluginUnderTestMetadata", PluginUnderTestMetadata) {
    pluginClasspath.from(project.configurations.named("compileOnly").get())
}

//Provider<Copy> copyLauncherForTests = tasks.register("copyLauncherForTests", Copy) {
//    from(launcherTar)
//    into(new File(project.tasks.named("processTestResources").get().outputs.files.singleFile, "META-INF"))
//    rename 'launcher-.*\\.tar', 'flask-launcher.tar'
//}
//
//tasks.named("processTestResources") {
//    inputs.files(copyLauncherForTests.get().outputs)
//}

//tasks.named("test", Test) {
//    println(it.classpath.files)
//}
//
//test {
//}